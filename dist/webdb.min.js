/*! [webdb 0.3.1](http://download.github.io/webdb) Copyright 2015 by [Stijn de Witt](http://StijnDeWitt.com). Some rights reserved. License: [CC-BY-4.0](https://creativecommons.org/licenses/by/4.0/) */
!function(u,m,d){var a;if("function"==typeof define&&define.amd)define("webdb",require.defined("picolog")?["picolog"]:[],d);else if("object"==typeof exports){try{require.resolve("picolog"),a=require("picolog")}catch(b){}module.exports=d(a)}else u.log&&log.info&&(a=log),u[m]=d(a)}(this,"WebDB",function(a){"use strict";function WebDB(i,j){function k(a,g){function i(a){var b=a[t.definition.pk];return b}function j(a,b){return a="object"==typeof a?i(a):a,b="object"==typeof b?i(b):b,c(a,b)}function k(){var a,b={};for(a in t.definition.columns)(t.definition.columns[a].fk||t.definition.columns[a].unique||t.definition.columns[a].index)&&(b[a]=new h({unique:t.definition.columns[a].unique}));return b}function n(a){var b,c,e,g,h,i={},j={},k={},l=[];"object"!=typeof a&&Object(a)instanceof t.definition.columns[t.definition.pk].type&&(g=a,a={},a[t.definition.pk]=g);for(e in a)t.definition.pk===e?h=a[e]:x[e]?i[e]=a[e]:j[e]=a[e];var n=!0;if("undefined"!=typeof h){for(Array.isArray(h)||(h=[h]),b=0;b<h.length;b++)k[h[b]]=1;n=!1}for(e in i)for(Array.isArray(i[e])||(i[e]=[i[e]]),b=0;b<i[e].length;b++){h=x[e].search(i[e][b]);var o={};for(c=0;c<h.length;c++)(n||k[h[c]])&&(o[h[c]]=1);k=o,n=!1}if(n)v.visit(function(a){a.data.length&&l.push(a.data[0])});else for(g in k){var p=v.search(g);p.length&&l.push(p[0])}for(b=0;b<l.length;b++)l[b]instanceof t.definition.entityType||(l[b]=t.definition.factory(l[b]));return Object.keys(j).length?f(l,j):l}function o(){var a=b(arguments,t,function(a){var b,c=null,e=v.search(a);if(e.length){c=e[0],v.update(i(a),a);for(b in x)c[b]!=a[b]&&(x[b].remove(c[b]),x[b].insert(a[b],i(a)))}else{v.insert(i(a),a);for(b in x)x[b].insert(a[b],i(a))}return r(a,c),[a]});return a}function p(){var a=b(arguments,t,function(a){var b,c,e=v.search(a);if(e.length){b=e[0],v.remove(i(a));for(c in x)x[c].remove(a[c])}return b=s(a,b),[b||a]});return a}function r(a,b){var c;return!g&&q.options.synch&&(c=e(A,a),-1!==c&&(b=A.splice(c,1)),t.persistent(a)?(c=e(z,a),-1===c?z.push(b):t.db.synching&&(c=e(C,a),-1===c?C.push(a):C.splice(c,1,a))):(c=e(y,a),-1===c&&y.push(a),c=e(A,a),-1!==c&&A.splice(c,1))),b}function s(a,b){var c,f,h;return!g&&q.options.synch&&(f=e(y,a),-1===f&&(c=e(z,a),-1!==c&&(h=z.splice(c,1)[0],b=b||h),c=e(C,a),-1!==c&&C.splice(c,1),c=e(A,a),-1===c&&A.push(b||a))),b}var t=this;Object.defineProperty(t,"db",{value:q}),Object.defineProperty(t,"name",{value:a}),Object.defineProperty(t,"definition",{enumerable:!0,get:function(){return w[a]}}),Object.defineProperty(t,"length",{enumerable:!0,get:function(){return v.keyCount()}}),Object.defineProperty(t,"synched",{enumerable:!0,get:function(){return!t.created||!(t.created.length||t.updated.length||t.deleted.length)}}),Object.defineProperty(t,"get",{get:function(){return function(a,b){return"function"==typeof a&&(b=a,a=null),b?new Promise(function(b){b(n(a))}):n(a)}}}),Object.defineProperty(t,"set",{get:function(){return function(){var a;return"function"==typeof arguments[arguments.length-1]&&(a=arguments[--arguments.length]),a?new Promise(function(a){a(o.apply(t,arguments))}):o.apply(t,arguments)}}}),Object.defineProperty(t,"del",{get:function(){return function(){var a;return"function"==typeof arguments[arguments.length-1]&&(a=arguments[--arguments.length]),a?new Promise(function(a){a(p.apply(t,arguments))}):p.apply(t,arguments)}}}),g||(Object.defineProperty(t,"created",{get:function(){return y.concat()}}),Object.defineProperty(t,"updated",{get:function(){return z.concat()}}),Object.defineProperty(t,"deleted",{get:function(){return A.concat()}}),Object.defineProperty(t,"stale",{get:function(){return B.concat()}}),Object.defineProperty(t,"future",{get:function(){return C.concat()}}),Object.defineProperty(t,"failed",{get:function(){return D.concat()}}),Object.defineProperty(t,"failure",{get:function(){return E}}));var v=new h({unique:!0,id:i,equals:j}),x=k();if(!g){var y=[],z=[],A=[],B=[],C=[],D=[],E=null;q.tables.set({name:a});for(var F in w[a].columns)q.columns.set(l({id:q.columns.length+1,name:F,table:a},w[a].columns[F]))}}function l(){var a,b,c,e,f,g=[].splice.call(arguments,0,1)[0]||{};for(a=0;c=arguments[a];a++)for(Array.isArray(c)||(c=[c]),b=0;e=c[b];b++)for(f in e)g[f]=e[f];return g}function n(a){a||(a=r),"columns"in a||(a={columns:a});for(var b in a.columns)if("function"==typeof a.columns[b]&&(a.columns[b]={type:a.columns[b]}),a.columns[b].pk){if(a.pk)throw new Error("Multiple primary key columns found in table definition: `"+a.pk+"` and `"+b+"`.");a.pk=b}if(!a.pk)throw new Error("No primary key column found in table definition.");return a}function o(a,b,c){w[a]=l(w[a]||{},r,n(b)),Object.defineProperty(q,a,{configurable:!0,enumerable:!0,writable:!1,value:v[a]=new k(a,c)})}var p={synch:!1,synchUrl:"/api/webdb/synch",synchAuto:!0,synchThrottleMs:3e3,synchPollMs:36e5};if(i=i||"webdb",g[i])return g[i];if(!(this instanceof WebDB))return new WebDB(i,j);j=l({},p,j);var q=g[i]=this;Object.defineProperty(q,"name",{enumerable:!1,value:i}),Object.defineProperty(q,"options",{enumerable:!1,get:function(){return l({},j)}}),Object.defineProperty(q,"synching",{enumerable:!1,get:function(){return x}}),Object.defineProperty(q,"lastSynched",{enumerable:!1,get:function(){return y}}),Object.defineProperty(q,"synched",{enumerable:!1,get:function(){if(0===q.lastSynched.getTime())return!1;for(var a in q.tables)if(!a.synched())return!1;return!0}}),Object.defineProperty(q,"synchError",{enumerable:!1,get:function(){return z}}),Object.defineProperty(q,"createTable",{enumerable:!1,get:function(){return function(a,b){if(v[a])throw new Error("A table named `"+a+"` already exists. Use alterTable() to change it's definition, or dropTable() to remove it.");return o(a,b),v[a]}}}),Object.defineProperty(q,"dropTable",{enumerable:!1,get:function(){return function(b){return v[b]?(delete q[b],delete v[b],void delete w[b]):void(a&&a.warn("Call to dropTable() is ignored.",new Error("No table named `"+b+"` exists.")))}}}),Object.defineProperty(q,"synch",{enumerable:!1,get:function(){return function a(b){return!A&&q.options.synchAuto&&(A=setInterval(a,q.options.synchThrottleMs)),x?x:(z=!1,x=new Promise(function(a,c){return!b&&q.synched&&Date.now()<q.lastSynched.getTime()+q.options.synchPollMs?setTimeout(function(){x=!1,a()},0):void c()}))}}}),k.prototype.persistent=function(a){return null!==a[this.definition.version]&&void 0!==a[this.definition.version]},k.prototype.toJSON=function(){},k.fromJSON=function(){};var r={columns:{id:{type:Number,pk:!0}},entityType:Object,factory:function(a){return new this.entityType(a)}},s={columns:{name:{type:String,length:32,pk:!0}}},t={columns:{id:{type:Number,pk:!0},name:{type:String,length:32,index:!0},table:{type:String,length:32,notnull:!0,fk:"tables"},type:Function,length:Number,notnull:Boolean,pk:Boolean,fk:{type:String,length:32},unique:Boolean,index:Boolean}},v={},w={},x=!1,y=new Date(0),z=null,A=!1;o("tables",s,!0),o("columns",t,!0),q.tables.set({name:"tables"},{name:"columns"});for(var B in s.columns)q.columns.set(l({id:q.columns.length+1,name:B,table:"tables"},s.columns[B]));for(var B in t.columns)q.columns.set(l({id:q.columns.length+1,name:B,table:"columns"},t.columns[B]));return q}function b(a,c,e){if("length"in a&&a.length&&a[a.length-1]){for(var f,g=[],h=0;f=a[h];h++)g.push.apply(g,b(f,c,e));return g}return e.call(c,a)}function c(a,b){return a===b||a.equals&&a.equals(b)||b.equals&&b.equals(a)||"object"==typeof a&&a.valueOf()==b||"object"==typeof b&&b.valueOf()==a||"object"==typeof a&&"object"==typeof b&&a.valueOf()==b.valueOf()}function e(a,b,e){for(var f,g=0;f=a[g];g++)if(c(f,b,e))return g;return-1}function f(a,b){var f,g,h,i,j=0,k=new Array(a.length);for(f=0,g;g=a[f];f++){i=!0;for(h in b)if(Array.isArray&&Array.isArray(b[h])||b[h]instanceof Array){if(-1===e(b[h],g[h])){i=!1;break}}else if(!c(a[f][h],b[h])){i=!1;break}i&&(k[j++]=g)}return k.length=j,k}a&&a.info("Found optional dependency `picolog`. Logging is enabled.");var g={},h=WebDB.Index=function(){function a(a,b){return b>a?-1:a>b?1:0}function b(a,b){return a===b}function c(c){this.root=new e(this,c),this.unique=c&&c.unique||!1,this.compare=c&&c.compare||a,this.equals=c&&c.equals||b,this.id=c&&c.id||void 0}function e(a,b){this.tree=a,b&&b.parent&&(this.parent=b.parent),b&&b.hasOwnProperty("key")&&(this.key=b.key),this.data=b&&b.hasOwnProperty("value")?[b.value]:[]}function f(a,b){return b.hasOwnProperty("$gt")||b.hasOwnProperty("$gte")?b.hasOwnProperty("$gt")&&b.hasOwnProperty("$gte")?0===a(b.$gte,b.$gt)?function(c){return a(c,b.$gt)>0}:a(b.$gte,b.$gt)>0?function(c){return a(c,b.$gte)>=0}:function(c){return a(c,b.$gt)>0}:b.hasOwnProperty("$gt")?function(c){return a(c,b.$gt)>0}:function(c){return a(c,b.$gte)>=0}:function(){return!0}}function g(a,b){return b.hasOwnProperty("$lt")||b.hasOwnProperty("$lte")?b.hasOwnProperty("$lt")&&b.hasOwnProperty("$lte")?0===a(b.$lte,b.$lt)?function(c){return a(c,b.$lt)<0}:a(b.$lte,b.$lt)<0?function(c){return a(c,b.$lte)<=0}:function(c){return a(c,b.$lt)<0}:b.hasOwnProperty("$lt")?function(c){return a(c,b.$lt)<0}:function(c){return a(c,b.$lte)<=0}:function(){return!0}}function h(a,b,c,e){var i=[];return a.hasOwnProperty("key")?(c=c||f(a.tree.compare,b),e=e||g(a.tree.compare,b),c(a.key)&&a.left&&i.push.apply(i,h(a.left,b,c,e)),c(a.key)&&e(a.key)&&i.push.apply(i,a.data),e(a.key)&&a.right&&i.push.apply(i,h(a.right,b,c,e)),i):i}function i(a){return(a.left?a.left.height:0)-(a.right?a.right.height:0)}function j(a){var b,c,e,f,g=a,h=a.left;return h?(b=h.right,g.parent?(h.parent=g.parent,g.parent.left===g?g.parent.left=h:g.parent.right=h):h.parent=null,h.right=g,g.parent=h,g.left=b,b&&(b.parent=g),c=h.left?h.left.height:0,e=b?b.height:0,f=g.right?g.right.height:0,g.height=Math.max(e,f)+1,h.height=Math.max(c,g.height)+1,h):g}function k(a){var b,c,e,f,g=a,h=a.right;return h?(b=h.left,g.parent?(h.parent=g.parent,g.parent.left===g?g.parent.left=h:g.parent.right=h):h.parent=null,h.left=g,g.parent=h,g.right=b,b&&(b.parent=g),c=g.left?g.left.height:0,e=b?b.height:0,f=h.right?h.right.height:0,g.height=Math.max(c,e)+1,h.height=Math.max(f,g.height)+1,h):g}function l(a){return i(a)<=1?a:(i(a.left)<0&&k(a.left),j(a))}function n(a){return i(a)>=-1?a:(i(a.right)>0&&j(a.right),k(a))}function o(a,b){var c,e,f=a;if(!a.hasOwnProperty("key"))return delete a.height,a;for(e=b.length-1;e>=0;e-=1)b[e].height=1+Math.max(b[e].left?b[e].left.height:0,b[e].right?b[e].right.height:0),i(b[e])>1&&(c=l(b[e]),0===e&&(f=c)),i(b[e])<-1&&(c=n(b[e]),0===e&&(f=c));return f}return c.prototype.insert=function(a,b){this.root=this.root.insert(a,b)},c.prototype.remove=function(a,b){this.root=this.root.remove(a,b)},["update","keyCount","search","visit"].forEach(function(a){c.prototype[a]=function(){return this.root[a].apply(this.root,arguments)}}),e.prototype.insert=function(a,b){var c=[],e=this;if(!this.hasOwnProperty("key"))return this.key=a,this.data.push(b),this.height=1,this;for(;;){if(0===this.tree.compare(e.key,a)){if(this.tree.unique)throw new Error("Can't insert key "+a+", it violates the unique constraint.");return e.data.push(b),this}if(c.push(e),this.tree.compare(a,e.key)<0){if(!e.left){e.left=new e.constructor(e.tree,{parent:e,key:a,value:b}),c.push(e.left);break}e=e.left}else{if(!e.right){e.right=new e.constructor(e.tree,{parent:e,key:a,value:b}),c.push(e.right);break}e=e.right}}return o(this,c)},e.prototype.update=function(a,b){if(!this.hasOwnProperty("key"))throw new Error("Can't update value ["+b+"] for key ["+a+"]. Key does not exist.");for(var c=this;;){if(0===this.tree.compare(c.key,a)){for(var e,f=-1,g=0;e=c.data[g];g++)if(this.tree.equals(e,b)){f=g;break}if(-1==f)throw new Error("Can't update value ["+b+"] for key ["+a+"]. Value is not present.");return c.data.splice(f,1,b),this}if(this.tree.compare(a,c.key)<0){if(!c.left)throw new Error("Can't update value ["+b+"] for key ["+a+"]. Key does not exist.");c=c.left}else{if(!c.right)throw new Error("Can't update value ["+b+"] for key ["+a+"]. Key is not present.");c=c.right}}},e.prototype.remove=function(a,b){var c,e=[],f=this,g=[];if(!this.hasOwnProperty("key"))return this;for(;;){if(0===this.tree.compare(a,f.key))break;if(g.push(f),this.tree.compare(a,f.key)<0){if(!f.left)return this;f=f.left}else{if(!f.right)return this;f=f.right}}if(f.data.length>1&&b)return f.data.forEach(function(d){this.tree.equals(d,b)||e.push(d)}),f.data=e,this;if(!f.left&&!f.right)return f===this?(delete f.key,f.data=[],delete f.height,this):(f.parent.left===f?f.parent.left=null:f.parent.right=null,o(this,g));if(!f.left||!f.right)return c=f.left?f.left:f.right,f===this?(c.parent=null,c):(f.parent.left===f?(f.parent.left=c,c.parent=f.parent):(f.parent.right=c,c.parent=f.parent),o(this,g));if(g.push(f),c=f.left,!c.right)return f.key=c.key,f.data=c.data,f.left=c.left,c.left&&(c.left.parent=f),o(this,g);for(;;){if(!c.right)break;g.push(c),c=c.right}return f.key=c.key,f.data=c.data,c.parent.right=c.left,c.left&&(c.left.parent=c.parent),o(this,g)},e.prototype.keyCount=function(){if(!this.hasOwnProperty("key"))return 0;var a=1;return this.left&&(a+=this.left.keyCount()),this.right&&(a+=this.right.keyCount()),a},e.prototype.search=function(a){if(!this.hasOwnProperty("key"))return[];var b;if("object"==typeof a){if(a.hasOwnProperty("$gt")||a.hasOwnProperty("$gte")||a.hasOwnProperty("$lt")||a.hasOwnProperty("$lte"))return h(this,a);this.tree.id&&(b=this.tree.id(a))}else b=a;return void 0===b?[]:0===this.tree.compare(this.key,b)?this.data:this.tree.compare(b,this.key)<0?this.left?this.left.search(b):[]:this.right?this.right.search(b):[]},e.prototype.visit=function(a){this.left&&this.left.visit(a),a(this),this.right&&this.right.visit(a)},c}();return WebDB});
//# sourceMappingURL=webdb.min.js.map