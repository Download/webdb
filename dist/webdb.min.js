/*! [webdb 0.4.1](http://download.github.io/webdb) Copyright 2015 by [Stijn de Witt](http://StijnDeWitt.com). Some rights reserved. License: [CC-BY-4.0](https://creativecommons.org/licenses/by/4.0/) */
!function(u,m,d){var a;if("function"==typeof define&&define.amd)define("webdb",require.defined("picolog")?["picolog"]:[],d);else if("object"==typeof exports){try{require.resolve("picolog"),a=require("picolog")}catch(b){}module.exports=d(a)}else u.log&&log.info&&(a=log),u[m]=d(a)}(this,"WebDB",function(a){"use strict";function WebDB(i,j){function k(g,i){function j(a){return a[T]}function k(a,b){return a="object"==typeof a?j(a):a,b="object"==typeof b?j(b):b,c(a,b)}function l(){var a,b={};for(a in H.definition.columns)(H.definition.columns[a].fk||H.definition.columns[a].unique||H.definition.columns[a].index)&&(b[a]=new h({unique:H.definition.columns[a].unique}));return b}function n(a){var b,c,e,g,h,i={},j={},k={},l=[];"object"!=typeof a&&Object(a)instanceof H.definition.columns[T].type&&(g=a,a={},a[T]=g);for(e in a)T===e?h=a[e]:J[e]?i[e]=a[e]:j[e]=a[e];var n=!0;if("undefined"!=typeof h){for(Array.isArray(h)||(h=[h]),b=0;b<h.length;b++)k[h[b]]=1;n=!1}for(e in i)for(Array.isArray(i[e])||(i[e]=[i[e]]),b=0;b<i[e].length;b++){h=J[e].search(i[e][b]);var o={};for(c=0;c<h.length;c++)(n||k[h[c]])&&(o[h[c]]=1);k=o,n=!1}if(n)I.visit(function(a){l.push.apply(l,a.data)});else for(g in k){var p=I.search(g);p.length&&l.push(p[0])}for(b=0;b<l.length;b++)l[b]instanceof H.definition.entityType||(l[b]=H.definition.factory(l[b]));return Object.keys(j).length?f(l,j):l}function o(){var a=b(arguments,H,function(a){var b=q(a);return r(a,b),[a]});return a}function q(a){var b,c,e=I.search(a);if(e.length){b=e[0],I.update(j(a),a);for(c in J)b[c]!=a[c]&&(J[c].remove(b[c]),J[c].insert(a[c],j(a)))}else{I.insert(j(a),a);for(c in J)J[c].insert(a[c],j(a))}return b}function r(a,b){var c;return!i&&t.options.synch&&(c=e(M,a),-1!==c&&(b=M.splice(c,1)),H.persistent(a)?(c=e(L,a),-1===c?L.push(b):H.db.synching&&(c=e(O,a),-1===c?O.push(a):O.splice(c,1,a))):(c=e(K,a),-1===c&&K.push(a),c=e(M,a),-1!==c&&M.splice(c,1))),b}function s(){var a=b(arguments,H,function(a){var b=v(j(a));return b=x(a,b),[b||a]});return a}function v(a){var b,c,e=I.search(a);if(e.length){b=e[0],I.remove(a);for(c in J)J[c].remove(b[c])}return b}function x(a,b){var c,f,g;return!i&&t.options.synch&&(f=e(K,a),-1===f&&(c=e(L,a),-1!==c&&(g=L.splice(c,1)[0],b=b||g),c=e(O,a),-1!==c&&O.splice(c,1),c=e(M,a),-1===c&&M.push(b||a))),b}function y(a,b){if(void 0===b)return b;for(var c,e={},f=0;c=a.columns[f];f++)e[c]=b[f];return e}function z(b){var c,e,f;for(e=0;f=y(b,b.created[e]);e++)q(f)||(c=!0);return a&&b.created.length&&a.debug("Processed "+b.created.length+" created items."),!!c}function B(b){var c,f,g,h,i,j,k;for(f=0;g=y(b,b.updated[f]);f++)if(h=e(O,g),-1!==h){j=O.splice(h,1)[0],h=e(L,g),-1!==h?L.splice(h,1,g):L.push(g),k=p({},g);for(i in j)i!==H.definition.version&&(k[i]=j[i]);q(k)}else h=e(L,g),-1!==h?L.splice(h,1):c=!0,q(g);return a&&b.updated.length&&a.debug("Processed "+b.updated.length+" updated items."),!!c}function C(b){var c,f,g,h;for(c=0;f=b.deletedIds[c];c++)v(f)&&(h=!0),g=e(M,f),-1!==g&&M.splice(g,1);return a&&b.deletedIds.length&&a.debug("Processed "+b.deletedIds.length+" deleted items."),!!h}function D(b){var c,f,g;for(c=0;f=y(b,b.stale[c]);c++)g=e(N,f),-1===g?N.push(f):N.splice(g,1,f),G(f);a&&b.stale.length&&a.debug("Processed "+b.stale.length+" stale items.")}function E(b){var c,f,g;for(c=0;f=y(b,b.failed[c]);c++)g=e(P,f),-1===g?P.push(f):P.splice(g,1,f),G(f);a&&b.failed.length&&a.debug("Processed "+b.failed.length+" failed items.")}function F(){}function G(a){var b;b=e(K,a),-1!==b&&K.splice(b,1),b=e(L,a),-1!==b&&L.splice(b,1),b=e(M,a),-1!==b&&M.splice(b,1)}var H=this;Object.defineProperty(H,"db",{value:t}),Object.defineProperty(H,"name",{value:g}),Object.defineProperty(H,"definition",{enumerable:!0,get:function(){return A[g]}}),Object.defineProperty(H,"length",{enumerable:!0,get:function(){return I.keyCount()}}),Object.defineProperty(H,"synched",{enumerable:!0,get:function(){return!H.created||!(H.created.length||H.updated.length||H.deleted.length)}}),Object.defineProperty(H,"get",{get:function(){return function(a,b){return"function"==typeof a&&(b=a,a=null),b?new Promise(function(b){b(n(a))}):n(a)}}}),Object.defineProperty(H,"set",{get:function(){return function(){var a;return"function"==typeof arguments[arguments.length-1]&&(a=arguments[--arguments.length]),a?new Promise(function(a){a(o.apply(H,arguments))}):o.apply(H,arguments)}}}),Object.defineProperty(H,"del",{get:function(){return function(){var a;return"function"==typeof arguments[arguments.length-1]&&(a=arguments[--arguments.length]),a?new Promise(function(a){a(s.apply(H,arguments))}):s.apply(H,arguments)}}}),i||(Object.defineProperty(H,"createSynchRequest",{get:function(){return function(){var a={ids:[],versions:[],created:[],updated:[],deleted:[]};return a.created.push.apply(a.created,H.created),a.updated.push.apply(a.updated,H.updated),a.deleted.push.apply(a.deleted,H.deleted),I.visit(function(b){a.ids.push(b.key),a.versions.push(b.data[0][H.definition.version])}),a}}}),Object.defineProperty(H,"processSynchResponse",{get:function(){return function(a){var b;return z(a)&&(b=!0),B(a)&&(b=!0),C(a)&&(b=!0),F(a),D(a),E(a),!!b}}}),Object.defineProperty(H,"created",{get:function(){return K.concat()}}),Object.defineProperty(H,"updated",{get:function(){return L.concat()}}),Object.defineProperty(H,"deleted",{get:function(){return M.concat()}}),Object.defineProperty(H,"stale",{get:function(){return N.concat()}}),Object.defineProperty(H,"future",{get:function(){return O.concat()}}),Object.defineProperty(H,"failed",{get:function(){return P.concat()}}),Object.defineProperty(H,"failure",{get:function(){return Q}}));var I=new h({unique:!0,id:j,equals:k}),J=l();if(!i){var K=[],L=[],M=[],N=[],O=[],P=[],Q=null;t.tables.set({name:g});for(var R in A[g].columns){var S={id:t.columns.length+1,name:R,table:g};S=p(S,w,A[g].columns[R]),t.columns.set(S)}}var T=i?"name":t.columns.get({table:g,pk:!0})[0].name}function l(){this.lastSynched=C;for(var a,b=0;a=z[b];b++)this[a.name]=a.createSynchRequest()}function n(a){for(var b,c,e=Object.keys(a),f=0;c=e[f];f++){var g=z[c]&&z[c].processSynchResponse;g&&g(a[c])&&(b=!0)}return b}function o(b){return new Promise(function(c,e){function f(){var a=new XMLHttpRequest;a.open("post",j.synchUrl,!0),a.setRequestHeader("Content-Type","application/json"),a.timeout=j.synchTimeout,a.addEventListener("readystatechange",g),a.addEventListener("error",i),a.addEventListener("timeout",i),a.send(JSON.stringify(b))}function g(){4===this.readyState&&(200===this.status?h.call(this):i.call(this))}function h(){l=0,c(JSON.parse(this.responseText))}function i(){switch(this.status){case 500:case 502:case 503:case 504:if(l>0){k();break}default:a&&a.error("WebDB `"+t.name+"`: Unable to synch with remote server.",this),l=0,e(this)}}function k(){l--,setTimeout(function(){f()},j.synchRetryWait)}var l=j.synchRetryCount;f()})}function p(){var a,b,c,e,f,g=[].splice.call(arguments,0,1)[0]||{};for(a=0;c=arguments[a];a++)for(Array.isArray(c)||(c=[c]),b=0;e=c[b];b++)for(f in e)g[f]=e[f];return g}function q(a){a||(a=v),a.columns||(a={columns:a});var b;for(var c in a.columns)if("function"==typeof a.columns[c]&&(a.columns[c]={type:a.columns[c]}),a.columns[c].pk){if(b)throw new Error("Multiple primary key columns found in table definition: `"+a.pk+"` and `"+c+"`.");b=c}if(!b)throw new Error("No primary key column found in table definition.");return a}function r(a,b,c){A[a]=p(A[a]||{},v,q(b)),Object.defineProperty(t,a,{configurable:!0,enumerable:!0,writable:!1,value:z[a]=new k(a,c)})}var s={synch:!1,synchUrl:"/api/webdb/synch",synchAuto:!0,synchThrottleMs:12e4,synchPollMs:36e5,synchTimeout:5e3,synchRetryCount:1,synchRetryWait:2e3};if(i=i||"webdb",g[i])return g[i];if(!(this instanceof WebDB))return new WebDB(i,j);j=p({},s,j);var t=g[i]=this;Object.defineProperty(t,"name",{enumerable:!1,value:i}),Object.defineProperty(t,"options",{enumerable:!1,get:function(){return p({},j)}}),Object.defineProperty(t,"synching",{enumerable:!1,get:function(){return B}}),Object.defineProperty(t,"lastSynched",{enumerable:!1,get:function(){return C}}),Object.defineProperty(t,"synched",{enumerable:!1,get:function(){if(0===t.lastSynched.getTime())return!1;for(var a in z)if(a.synched===!1)return!1;return!0}}),Object.defineProperty(t,"upToDate",{enumerable:!1,get:function(){return Date.now()<C.getTime()+j.synchPollMs}}),Object.defineProperty(t,"synchError",{enumerable:!1,get:function(){return D}}),Object.defineProperty(t,"createTable",{enumerable:!1,get:function(){return function(a,b){if(z[a])throw new Error("A table named `"+a+"` already exists. Use alterTable() to change it's definition, or dropTable() to remove it.");return r(a,b),z[a]}}}),Object.defineProperty(t,"dropTable",{enumerable:!1,get:function(){return function(b){return z[b]?(delete t[b],delete z[b],void delete A[b]):void(a&&a.warn("Call to dropTable() is ignored.",new Error("No table named `"+b+"` exists.")))}}}),Object.defineProperty(t,"synch",{enumerable:!1,get:function(){return function b(c){return B?B:(!E&&j.synchAuto&&(E=setInterval(b,j.synchThrottleMs)),D=!1,B=new Promise(function(b,e){!c&&t.synched&&t.upToDate&&b();try{a&&a.info("Synching WebDB `"+t.name+"`...");var f=new l;o(f).then(function(c){var e=n(c);C=new Date,B=!1,e&&a&&a.debug("WebDB `"+t.name+"` changed. Triggering change..."),a&&a.debug("WebDB `"+t.name+"` triggering success...."),b(),a&&a.debug("WebDB `"+t.name+"` triggering done...."),a&&a.debug("WebDB `"+t.name+"` synch done."),a&&a.debug("WebDB `"+t.name+"` synched succesfully.")},function(b){a&&a.warn("WebDB `"+t.name+"` failed to synch with remote server.",b),B=!1,D=b,e(b)})["catch"](function(b){a&&a.error("WebDB `"+t.name+"` failed to process synch response from remote server.",b),B=!1,D=b,e(b)})}catch(g){a&&a.error("WebDB `"+t.name+"` had an error during synching.",g),B=!1,D=g,e(g)}}))}}}),k.prototype.persistent=function(a){return null!==a[this.definition.version]&&void 0!==a[this.definition.version]},k.prototype.toJSON=function(){},k.fromJSON=function(){};var v={columns:{id:{type:Number,pk:!0}},entityType:Object,factory:function(a){return new this.entityType(a)}},w={type:void 0,length:0,notnull:!1,pk:!1,fk:void 0,unique:!1,index:!1},x={columns:{name:{type:String,length:32,pk:!0}}},y={columns:{id:{type:Number,pk:!0},name:{type:String,length:32,index:!0},table:{type:String,length:32,notnull:!0,fk:"tables"},type:Function,length:Number,notnull:Boolean,pk:Boolean,fk:{type:String,length:32},unique:Boolean,index:Boolean}},z={},A={},B=!1,C=new Date(0),D=null,E=!1;r("tables",x,!0),r("columns",y,!0),t.tables.set({name:"tables"},{name:"columns"});for(var F in x.columns)t.columns.set(p({id:t.columns.length+1,name:F,table:"tables"},x.columns[F]));for(var F in y.columns)t.columns.set(p({id:t.columns.length+1,name:F,table:"columns"},y.columns[F]));return t}function b(a,c,e){if("length"in a&&a.length&&a[a.length-1]){for(var f,g=[],h=0;f=a[h];h++)g.push.apply(g,b(f,c,e));return g}return e.call(c,a)}function c(a,b){return a===b||a.equals&&a.equals(b)||b.equals&&b.equals(a)||"object"==typeof a&&a.valueOf()==b||"object"==typeof b&&b.valueOf()==a||"object"==typeof a&&"object"==typeof b&&a.valueOf()==b.valueOf()}function e(a,b,e){for(var f,g=0;f=a[g];g++)if(c(f,b,e))return g;return-1}function f(a,b){var f,g,h,i,j=0,k=new Array(a.length);for(f=0,g;g=a[f];f++){i=!0;for(h in b)if(Array.isArray&&Array.isArray(b[h])||b[h]instanceof Array){if(-1===e(b[h],g[h])){i=!1;break}}else if(!c(a[f][h],b[h])){i=!1;break}i&&(k[j++]=g)}return k.length=j,k}a&&a.info("Found optional dependency `picolog`. Logging is enabled.");var g={},h=WebDB.Index=function(){function a(a,b){return b>a?-1:a>b?1:0}function b(a,b){return a===b}function c(c){this.root=new e(this,c),this.unique=c&&c.unique||!1,this.compare=c&&c.compare||a,this.equals=c&&c.equals||b,this.id=c&&c.id||void 0}function e(a,b){this.tree=a,b&&b.parent&&(this.parent=b.parent),b&&b.hasOwnProperty("key")&&(this.key=b.key),this.data=b&&b.hasOwnProperty("value")?[b.value]:[]}function f(a,b){return b.hasOwnProperty("$gt")||b.hasOwnProperty("$gte")?b.hasOwnProperty("$gt")&&b.hasOwnProperty("$gte")?0===a(b.$gte,b.$gt)?function(c){return a(c,b.$gt)>0}:a(b.$gte,b.$gt)>0?function(c){return a(c,b.$gte)>=0}:function(c){return a(c,b.$gt)>0}:b.hasOwnProperty("$gt")?function(c){return a(c,b.$gt)>0}:function(c){return a(c,b.$gte)>=0}:function(){return!0}}function g(a,b){return b.hasOwnProperty("$lt")||b.hasOwnProperty("$lte")?b.hasOwnProperty("$lt")&&b.hasOwnProperty("$lte")?0===a(b.$lte,b.$lt)?function(c){return a(c,b.$lt)<0}:a(b.$lte,b.$lt)<0?function(c){return a(c,b.$lte)<=0}:function(c){return a(c,b.$lt)<0}:b.hasOwnProperty("$lt")?function(c){return a(c,b.$lt)<0}:function(c){return a(c,b.$lte)<=0}:function(){return!0}}function h(a,b,c,e){var i=[];return a.hasOwnProperty("key")?(c=c||f(a.tree.compare,b),e=e||g(a.tree.compare,b),c(a.key)&&a.left&&i.push.apply(i,h(a.left,b,c,e)),c(a.key)&&e(a.key)&&i.push.apply(i,a.data),e(a.key)&&a.right&&i.push.apply(i,h(a.right,b,c,e)),i):i}function i(a){return(a.left?a.left.height:0)-(a.right?a.right.height:0)}function j(a){var b,c,e,f,g=a,h=a.left;return h?(b=h.right,g.parent?(h.parent=g.parent,g.parent.left===g?g.parent.left=h:g.parent.right=h):h.parent=null,h.right=g,g.parent=h,g.left=b,b&&(b.parent=g),c=h.left?h.left.height:0,e=b?b.height:0,f=g.right?g.right.height:0,g.height=Math.max(e,f)+1,h.height=Math.max(c,g.height)+1,h):g}function k(a){var b,c,e,f,g=a,h=a.right;return h?(b=h.left,g.parent?(h.parent=g.parent,g.parent.left===g?g.parent.left=h:g.parent.right=h):h.parent=null,h.left=g,g.parent=h,g.right=b,b&&(b.parent=g),c=g.left?g.left.height:0,e=b?b.height:0,f=h.right?h.right.height:0,g.height=Math.max(c,e)+1,h.height=Math.max(f,g.height)+1,h):g}function l(a){return i(a)<=1?a:(i(a.left)<0&&k(a.left),j(a))}function n(a){return i(a)>=-1?a:(i(a.right)>0&&j(a.right),k(a))}function o(a,b){var c,e,f=a;if(!a.hasOwnProperty("key"))return delete a.height,a;for(e=b.length-1;e>=0;e-=1)b[e].height=1+Math.max(b[e].left?b[e].left.height:0,b[e].right?b[e].right.height:0),i(b[e])>1&&(c=l(b[e]),0===e&&(f=c)),i(b[e])<-1&&(c=n(b[e]),0===e&&(f=c));return f}return c.prototype.insert=function(a,b){this.root=this.root.insert(a,b)},c.prototype.remove=function(a,b){this.root=this.root.remove(a,b)},["update","keyCount","search","visit"].forEach(function(a){c.prototype[a]=function(){return this.root[a].apply(this.root,arguments)}}),e.prototype.insert=function(a,b){var c=[],e=this;if(!this.hasOwnProperty("key"))return this.key=a,this.data.push(b),this.height=1,this;for(;;){if(0===this.tree.compare(e.key,a)){if(this.tree.unique)throw new Error("Can't insert key "+a+", it violates the unique constraint.");return e.data.push(b),this}if(c.push(e),this.tree.compare(a,e.key)<0){if(!e.left){e.left=new e.constructor(e.tree,{parent:e,key:a,value:b}),c.push(e.left);break}e=e.left}else{if(!e.right){e.right=new e.constructor(e.tree,{parent:e,key:a,value:b}),c.push(e.right);break}e=e.right}}return o(this,c)},e.prototype.update=function(a,b){if(!this.hasOwnProperty("key"))throw new Error("Can't update value ["+b+"] for key ["+a+"]. Key does not exist.");for(var c=this;;){if(0===this.tree.compare(c.key,a)){for(var e,f=-1,g=0;e=c.data[g];g++)if(this.tree.equals(e,b)){f=g;break}if(-1==f)throw new Error("Can't update value ["+b+"] for key ["+a+"]. Value is not present.");return c.data.splice(f,1,b),this}if(this.tree.compare(a,c.key)<0){if(!c.left)throw new Error("Can't update value ["+b+"] for key ["+a+"]. Key does not exist.");c=c.left}else{if(!c.right)throw new Error("Can't update value ["+b+"] for key ["+a+"]. Key is not present.");c=c.right}}},e.prototype.remove=function(a,b){var c,e=[],f=this,g=[];if(!this.hasOwnProperty("key"))return this;for(;;){if(0===this.tree.compare(a,f.key))break;if(g.push(f),this.tree.compare(a,f.key)<0){if(!f.left)return this;f=f.left}else{if(!f.right)return this;f=f.right}}if(f.data.length>1&&b)return f.data.forEach(function(d){this.tree.equals(d,b)||e.push(d)}),f.data=e,this;if(!f.left&&!f.right)return f===this?(delete f.key,f.data=[],delete f.height,this):(f.parent.left===f?f.parent.left=null:f.parent.right=null,o(this,g));if(!f.left||!f.right)return c=f.left?f.left:f.right,f===this?(c.parent=null,c):(f.parent.left===f?(f.parent.left=c,c.parent=f.parent):(f.parent.right=c,c.parent=f.parent),o(this,g));if(g.push(f),c=f.left,!c.right)return f.key=c.key,f.data=c.data,f.left=c.left,c.left&&(c.left.parent=f),o(this,g);for(;;){if(!c.right)break;g.push(c),c=c.right}return f.key=c.key,f.data=c.data,c.parent.right=c.left,c.left&&(c.left.parent=c.parent),o(this,g)},e.prototype.keyCount=function(){if(!this.hasOwnProperty("key"))return 0;var a=1;return this.left&&(a+=this.left.keyCount()),this.right&&(a+=this.right.keyCount()),a},e.prototype.search=function(a){if(!this.hasOwnProperty("key"))return[];var b;if("object"==typeof a){if(a.hasOwnProperty("$gt")||a.hasOwnProperty("$gte")||a.hasOwnProperty("$lt")||a.hasOwnProperty("$lte"))return h(this,a);this.tree.id&&(b=this.tree.id(a))}else b=a;return void 0===b?[]:0===this.tree.compare(this.key,b)?this.data:this.tree.compare(b,this.key)<0?this.left?this.left.search(b):[]:this.right?this.right.search(b):[]},e.prototype.visit=function(a){this.left&&this.left.visit(a),a(this),this.right&&this.right.visit(a)},c}();return WebDB});
//# sourceMappingURL=webdb.min.js.map